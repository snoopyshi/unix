
## ISO/OSI 模型

OSI (Open System interconnection) 开放系统互联模型是由 ISO (International Organization for Standardization) 国际标准化组织定义的网络分层模型, 共七层  


```shell  
七层模型:  
    主机A               主机B
   应用层 <-------------> 应用层               apdu, 提供应用程序通信
   表示层 <-------------> 表示层               ppdu, 处理数据格式,数据加密等            
   会话层 <-------------> 会话层               spdu, 建立,维护和管理会话
   传输层 <-------------> 传输层               segment, 建立端到端链接
   网络层 <-------------> 网络层               packet,  寻址和路由选择
   数据链路层 <-------------> 数据链路层        frame   介质访问,链路管理
   物理层 <------物理协议-------> 物理层        比特流, 比特传输

四层模型:

    应用层 <-------> 应用层   ftp, http 等应用协议
    传输层 <-------> 传输层   tcp/udp等
    网络层 <-------> 网络层   ip,数据包
    链路层 <-------> 链路层   比特流 
   
```


### 基本概念

1、对等通信  

2、封装  
在发送端, 数据传输是从上到下, 每经过一层, 需要封装数据到下一层去.

3、分用  
在接收端, 数据传输是从下到上, 没经过一层, 需要解析该层的数据头,然后分用到具体的上一层去

4、端口  
区分应用层的应用


### 第二节  

1、 最大传输单元(MTU, maxinum transmission unit)/路径MTU  
2、 以太网帧格式  
3、 ICMP    ----> IP
4、 ARP     
5、 RARP

如果ip层有一个数据报要传, 而且数据的长度比链路层的MTU还大,那么ip层就要进行分片(Fragmentation),把
数据分成若干片,这样每一片都小于MTU  

当网络上的两台主机互相进行通信时,两台主机之间要经过多个网络,每个网络的链路层可能有不同的MTU,其中两台通信主机路径中的最小MTU被称作路径MTU  

以太网帧格式:

「目的地址」「源地址」「类型」「数据」「CRC」  

其中数据有以下几种(通过类型来区分):  
- ip数据报(0800)  
- ARP请求/应答(0806)  
- RARP请求/应答(8035)  

ICMP 协议用于传递差错消息,时间,回显,网络信息等控制数据  
工作于ip层  

ICMP 数据格式  

「ip头部」「ICMP报文」
 20字节    



ip  -> mac 地址解析, ARP
mac -> ip  反向地址解析, RARP


### 第三节

1、 IP 数据报格式  
2、 网际校验和  
3、 路由  
搜索匹配的主机地址
搜索网络地址
搜索默认表项

### 第四节  

1、tcp 特点
基于字节流(segment), 会出现粘包问题,
面向连接
可靠传输
缓冲传输
全双工
流量控制
2、tcp 报文格式

「IP头部」「tcp头部」「tcp数据」
  20字节   20 字节    tcp
[-----------packet-------------]

6个标志位
URG - 紧急指针有效
ACK - 确认序号有效
PSH - 接收方应尽快将这个报文端交给应用层
RST - 链接重制
SYN - 同步序号用来发起一个链接
FIN - 表示将要终止一个链接

窗口大小
通过窗口大小来达到流量控制

校验和
对tcp头与数据进行校验

16 位紧急指针
是一个正的偏移量, 与序号字段中的值相加表示紧急数据最后一个字节的序号.

4 个字节的整数倍. 选项与填充

3、连接建立三次握手

4、连接终止四次握手
5、tcp如何保证可靠性

不可靠:
差错      --> 端到端的校验和
丢包      --> 超时重传+确认
失序      --> 通过序号保证. 每个包都有一个序号机制, 接收方收到包后会根据序号重排
重复      --> 序号

应用数据被分割成tcp认为最适合发送的数据块, 称为段传递给ip层.
当tcp发出一个段后, 它启动一个定时器,等待目的端确认收到这个报文段, 如果不能及时收到一个确认,将重传这个报文段
当tcp收到发自tcp链接另一端的数据, 它将发送一个确认. 这个确认不是立即发送,通常将推迟几分之一秒

tcp将保持它首部和数据的校验和,这是一个端都端的校验和,目的是校验数据在传输过程中的任何变化. 如果收到段的校验和有差错,tcp将丢弃这个报文段并且不确认(导致对方超时重传)

tcp 承载与ip数据报来传输,而ip数据报的到达可能会失序,tcp将对收到的数据进行重新排序

ip数据报回发生重复,tcp的接受端必须丢弃重复的数据
tcp还能提供流量控制,tcp链接的每一方都有一定大小的缓冲空间.(滑动窗口机制)

### 第五节
滑动窗口协议
通告接收窗口(rwnd): 预防应用程序发送的数据超过对方的缓冲区. 接收方使用的流量控制

拥塞窗口(cwnd): 预防应用程序发送的数据超过网络所能承受的能力. 发送方使用的流量控制

发送窗口取两者较小值
慢启动阈值(ssthresh: slow start threshold)
慢启动阶段:cwnd 从 1 开始按指数增长直到sshresh

拥塞避免阶段: cwnd按线性增长, 直到拥塞,将cwnd=1, ssthresh减半


udp 特点

无链接
不可靠
一般情况下udp更加高效


### 第六节

字节序:
- 大端字节序
- 小端字节序

网络字节序

主机字节序

字节转换相关函数:
uint32_t htonl(uint32_t hostlong);
uint16_t htons(uint32_t hostshort);
uint32_t nhohl(uint32_t netlong);
uint16_t ntohs(uint16_t netshort);
在上述函数中,h代表host, n代表network s代表short, l代表long

地址转换函数:
int inet_aton(const char* cp, struct in_addr *inp);
in_addr_t inet_addr(const char *cp);//cp 十进制的ip地址 192.168.0.100

char *inet_ntoa(struct in_addr in);


套接字类型
- 流式套接字(socket_stream)
提供面向链接的,可靠的数据传输服务,数据无差错,无重复的发送, 且按发送顺序接收
- 数据报式套接字(socket_dgram)
提供无链接服务.不提供无错保证,数据可能丢失或重复,并且接受顺序混乱
- 原始套接字(socket_raw)

### 第七节
1、tcp客户端/服务器模型
2、回射客户/服务器
3、socket、bind、listen、accept、connect

回射客户服务器存在的问题:
1、地址重复利用的问题
2、不能处理多个客户端的链接

### 第八节

1、REUSEADDR 的用法  
服务器端尽可能使用 REUSEADDR  
在绑定之前尽可能调用 setsockopt 来设置reuseaddr套接字选项  
使用REUSEADDR选项可以使得不必等待TIME_WAIT状态消失就可以重启服务器.  

处理多客户链接(process-per-connection)
点对点聊天程序实现


